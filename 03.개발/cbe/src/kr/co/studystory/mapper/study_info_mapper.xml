<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.studystory.studyinfo">
	<!-- 스터디 상세 정보 조회. - 진행중. -->
	<resultMap type="kr.co.studystory.domain.StudyInfoDomain" id="studyInfoResult">
		<result column="STUDY_NAME" property="studyName" />
		<result column="LOC" property="loc" />
		<result column="CATEGORY" property="category" />
		<result column="CONTENT" property="content" />
		<result column="study_img" property="studyImg" />
		<result column="user_img" property="leaderImg" />
		<result column="INPUT_DATE" property="inputDate" />
		<result column="NICK" property="nick" />
		<result column="INTRODUCE" property="introduce" />
		<result column="recruitment" property="recruitment" />
		<result column="deactivation" property="deactivation" />
	</resultMap>

	<select id="selectDetailStudy" parameterType="String" resultMap="studyInfoResult">
		SELECT S.STUDY_NAME, LOC, CATEGORY, CONTENT, S.IMG STUDY_IMG, TO_CHAR(S.INPUT_DATE,'YYYY/MM/DD') INPUT_DATE, U.NICK, U.INTRODUCE, U.IMG USER_IMG, s.recruitment, s.deactivation
		FROM STUDY S, USER_TABLE U
		WHERE S_NUM = #{ sNum } AND ( S.ID = U.ID ) 
	</select>
	<select id="selectFavNum" parameterType="String" resultType="int">
		SELECT COUNT(*) cnt
		FROM fav_study
		WHERE s_num=#{ s_num }
	</select>
	<select id="selectMemberNum" parameterType="String" resultType="int">
		SELECT COUNT(*) cnt
		FROM member
		WHERE s_num=#{ s_num }
	</select>
	<!-- 스터디 상세 정보 조회. -->

	<!-- 스터디 상세 정보의 댓글 조회 -->
	<select id="selectStudyCommentList" resultType="kr.co.studystory.domain.StudyCommentDomain" parameterType="String">
		SELECT SC.S_COMMENT, TO_CHAR(SC.INPUT_DATE, 'yyyy/mm/dd') INPUT_DATE, SC.ID 
		FROM STUDY STD, S_COMMENT SC
		WHERE STD.S_NUM=SC.S_NUM AND SC.S_NUM= #{ sNum }
		ORDER BY INPUT_DATE DESC
	</select>
	<!-- 스터디 상세 정보의 댓글 조회 -->
	
	<!-- 스터디 참여하기 페이지의 기본 정보 조회. -->
	<select id="selectLeaderOfJoin" resultType="kr.co.studystory.domain.LeaderOfJoinDomain" parameterType="String">
		SELECT UT.IMG leaderImg, UT.NICK nick, STD.STUDY_NAME studyName
		FROM USER_TABLE UT, STUDY STD
		WHERE UT.ID = STD.ID AND STD.S_NUM = #{SNUM}
	</select>
	<!-- 스터디 참여하기 페이지의 기본 정보 조회. -->
	
	<!-- 댓글 인서트 -->
	<insert id="insertComment" parameterType="kr.co.studystory.vo.ReplyVO">
		insert into s_comment(s_num, s_comment, id, input_date)
		values(#{ sNum }, #{ reply }, #{ joinerId }, SYSDATE)
	</insert>
	<!-- 댓글 인서트 -->

	<!-- JoinFormVO & alarmVO 인서트 -->
	<insert id="insertJoinFormVO" parameterType="kr.co.studystory.vo.JoinFormVO">
		INSERT INTO JOIN(ID, S_NUM, INTRODUCE, MOTIVE, ACCEPT_FLAG, INPUT_DATE)
		VALUES(#{joinerId}, #{sNum}, #{introduce_ta}, #{apply_ta}, 'N', SYSDATE)
	</insert>

 	<insert id="insertJoinAlarm" parameterType="kr.co.studystory.vo.JoinAlarmVO">
 		INSERT INTO ALARM(A_NUM, CATEGORY, SUBJECT, CONTENT, INPUT_DATE,  READ_FLAG, ID)
		VALUES(A_CODE, '스터디', '스터디 참여신청', #{content}, SYSDATE, 'N', ( select id from study where study_name = #{studyName} ) )
 	</insert>
	
	
	<!-- JoinFormVO & alarmVO 인서트 -->
	
</mapper>